name: Price Alert SMS

on:
  schedule:
    - cron: "*/30 * * * *" # every 30 minutes
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - run: npm ci

      # Install Playwright browsers & dependencies
      - run: npx playwright install --with-deps

      # Run Playwright test with no retries
      - name: Run Playwright test
        id: playwright_test
        run: npx playwright test --retries=0
        continue-on-error: true # Important! Allows workflow to continue even if test fails

      # Read price from Playwright output
      - name: Set price variable
        id: price
        run: |
          cat price.txt 
          echo "PRICE=$(cat price.txt)" >> $GITHUB_ENV
        continue-on-error: true
      # Send SMS via Courier **only if test failed**
      - name: Send SMS via Courier
        if: steps.playwright_test.outcome == 'failure'
        run: |
          curl -X POST https://api.courier.com/send \
          -H "Authorization: Bearer token_3TFRN33VF6MWRBGWD3H8FW2RRK6D" \
          -H "Content-Type: application/json" \
          -d "{
            \"message\": {
              \"to\": { \"phone_number\": \"+61420808520\" },
              \"template\": \"price-alert-sms\",
              \"data\": {
                \"price\": \"${{ env.PRICE }}\",
                \"url\": \"https://www.perthmint.com/shop/bullion/cast-bars/perth-mint-1oz-gold-cast-bar/\"
              }
            }
          }"
