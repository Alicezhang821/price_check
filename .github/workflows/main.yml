name: Price Alert SMS

on:
  schedule:
    - cron: "*/30 * * * *" # every 30 minutes
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - run: npm ci

      # Install Playwright browsers & dependencies
      - run: |
          npx playwright install --with-deps
          npm install twilio --save

      # Run Playwright test with no retries
      - name: Run Playwright test
        id: playwright_test
        run: npx playwright test --retries=0
        continue-on-error: true # Important! Allows workflow to continue even if test fails

      # Read price from Playwright output
      - name: Set price variable
        id: price
        run: |
          cat price.txt 
          echo "PRICE=$(cat price.txt)" >> $GITHUB_ENV
        continue-on-error: true
      - name: Send SMS via Twilio
        run: |
          TO_NUMBER="+61498988182"
          MESSAGE_BODY="Alert! Current gold price: ${{ env.PRICE }} AUD. Check: https://www.perthmint.com/shop/bullion/cast-bars/perth-mint-1oz-gold-cast-bar/"
          node send-sms.js
        env:
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM_NUMBER: "+61420808520"
          MESSAGE_BODY: "Alert! Current gold price: ${{ env.PRICE }} AUD."
